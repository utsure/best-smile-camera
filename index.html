<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>パーソナル・スマイルカメラ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    :root { --primary-bg: #2c3e50; --secondary-bg: #34495e; --accent-color: #f39c12; --text-color: #ecf0f1; --highlight-color: #3498db; }
    html, body { height: 100%; margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; background: var(--primary-bg); color: var(--text-color); }
    .app-screen { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; box-sizing: border-box; }
    .hidden { display: none !important; }

    /* 各画面のスタイル */
    h1 { font-size: 28px; color: var(--accent-color); }
    p { font-size: 18px; max-width: 400px; line-height: 1.5; }
    .button { background: var(--highlight-color); color: white; border: none; border-radius: 10px; padding: 15px 30px; font-size: 20px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
    .button:hover { transform: scale(1.05); }

    /* 撮影画面のスタイル */
    #live-screen { justify-content: flex-start; }
    #video-container { position: relative; width: 95vw; max-width: 500px; border-radius: 15px; overflow: hidden; box-shadow: 0 8px 16px rgba(0,0,0,0.4); margin-top: 20px; }
    #video-container::before { content: ''; display: block; padding-top: calc(3 / 4 * 100%); }
    video, #overlay-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    #smile-meter { width: 95%; max-width: 500px; height: 30px; background: var(--secondary-bg); border-radius: 15px; overflow: hidden; margin-top: 20px; border: 2px solid #fff; }
    #smile-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71); transition: width 0.2s; }
    #smile-threshold { position: absolute; left: 80%; height: 100%; border-left: 3px dashed var(--accent-color); }

    /* プレゼント画面のスタイル */
    #present-screen { position: fixed; top: 0; left: 0; z-index: 100; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
    #present-photo { border: 5px solid white; border-radius: 10px; max-width: 90vw; max-height: 70vh; box-shadow: 0 0 30px white; }
    .present-buttons { margin-top: 20px; display: flex; gap: 20px; }

    /* 紙吹雪用のキャンバス */
    #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 101; pointer-events: none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
</head>

<body>
  <div id="start-screen" class="app-screen">
    <h1>パーソナル・スマイルカメラ</h1>
    <p>あなただけの「最高の笑顔」をAIが学習し、自動で撮影します。はじめに2つのステップであなたの表情を登録しましょう。</p>
    <button id="start-calibration-button" class="button">キャリブレーション開始</button>
  </div>

  <div id="neutral-screen" class="app-screen hidden">
    <h1>ステップ1：真顔の登録</h1>
    <p>カメラを見て、リラックスした真顔を3秒間キープしてください。</p>
    <div id="neutral-progress">3</div>
  </div>

  <div id="smile-screen" class="app-screen hidden">
    <h1>ステップ2：最高の笑顔の登録</h1>
    <p>カメラを見て、あなたができる最高の笑顔を5秒間キープしてください！</p>
    <div id="smile-progress">5</div>
  </div>

  <div id="live-screen" class="app-screen hidden">
    <p>準備完了！最高の笑顔を見せてください！</p>
    <div id="video-container">
      <video id="input_video" autoplay muted playsinline></video>
      <canvas id="overlay-canvas"></canvas>
    </div>
    <div id="smile-meter">
      <div id="smile-bar"><div id="smile-threshold"></div></div>
    </div>
  </div>

  <div id="present-screen" class="app-screen hidden">
    <h1>あなたの最高の笑顔です！</h1>
    <img id="present-photo" alt="最高の笑顔">
    <div class="present-buttons">
      <a id="download-link" class="button">保存する</a>
      <button id="retry-button" class="button">もう一度</button>
    </div>
  </div>
  
  <canvas id="confetti-canvas"></canvas>

  <script>
    // 各画面の要素
    const screens = {
      start: document.getElementById('start-screen'),
      neutral: document.getElementById('neutral-screen'),
      smile: document.getElementById('smile-screen'),
      live: document.getElementById('live-screen'),
      present: document.getElementById('present-screen')
    };
    const video = document.getElementById('input_video');
    const smileBar = document.getElementById('smile-bar');

    // キャリブレーション用変数
    let neutralScore = 0;
    let maxSmileScore = 0;
    let personalizedThreshold = 0;
    let isCapturing = false;

    function switchScreen(screenName) {
      Object.values(screens).forEach(s => s.classList.add('hidden'));
      screens[screenName].classList.remove('hidden');
    }

    // --- 1. モデル読み込み & カメラ起動 ---
    async function initialize() {
      await Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri('./models'),
        faceapi.nets.faceLandmark68Net.loadFromUri('./models')
      ]);
      await startVideo();
      switchScreen('start');
    }

    function startVideo() {
      return new Promise((resolve, reject) => {
        navigator.mediaDevices.getUserMedia({ video: {} })
          .then(stream => { video.srcObject = stream; resolve(); })
          .catch(err => { alert("カメラの起動に失敗しました。"); reject(err); });
      });
    }

    // --- 2. キャリブレーション処理 ---
    document.getElementById('start-calibration-button').onclick = async () => {
      // 真顔のキャリブレーション
      switchScreen('neutral');
      let neutralScores = [];
      for (let i = 3; i > 0; i--) {
        document.getElementById('neutral-progress').innerText = i;
        const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
        if (detection) neutralScores.push(getSmileIntensity(detection.landmarks));
        await new Promise(r => setTimeout(r, 1000));
      }
      neutralScore = neutralScores.reduce((a, b) => a + b, 0) / neutralScores.length;

      // 笑顔のキャリブレーション
      switchScreen('smile');
      let smileScores = [];
      for (let i = 5; i > 0; i--) {
        document.getElementById('smile-progress').innerText = i;
        const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
        if (detection) smileScores.push(getSmileIntensity(detection.landmarks));
        await new Promise(r => setTimeout(r, 1000));
      }
      maxSmileScore = Math.max(...smileScores);

      // 個人用しきい値の計算 (真顔と笑顔の中間より80%笑顔に近い点)
      personalizedThreshold = neutralScore + (maxSmileScore - neutralScore) * 0.8;
      
      switchScreen('live');
      runDetection();
    };
    
    // --- 3. 認識と撮影 ---
    function getSmileIntensity(landmarks) {
        const noseBottom = landmarks.getNose()[3]; // 鼻の下
        const mouthLeft = landmarks.getMouth()[0]; // 左口角
        const mouthRight = landmarks.getMouth()[6]; // 右口角
        const mouthCornerY = (mouthLeft.y + mouthRight.y) / 2;
        return noseBottom.y - mouthCornerY;
    }

    async function runDetection() {
      if (isCapturing) return;

      const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
      if (detection) {
        const currentSmileIntensity = getSmileIntensity(detection.landmarks);
        
        // スマイルメーターを更新
        const progress = Math.max(0, (currentSmileIntensity - neutralScore) / (maxSmileScore - neutralScore) * 100);
        smileBar.style.width = `${progress}%`;

        if (currentSmileIntensity > personalizedThreshold) {
          isCapturing = true;
          takePhoto();
        }
      }
      requestAnimationFrame(runDetection); // 次のフレームで再帰的に呼び出し
    }

    function takePhoto() {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL('image/jpeg');

      // プレゼント画面の表示
      document.getElementById('present-photo').src = dataUrl;
      document.getElementById('download-link').href = dataUrl;
      document.getElementById('download-link').download = `best_smile_${new Date().toISOString()}.jpg`;
      switchScreen('present');

      // 紙吹雪でお祝い
      const confettiCanvas = document.getElementById('confetti-canvas');
      const myConfetti = confetti.create(confettiCanvas, { resize: true });
      myConfetti({ particleCount: 200, spread: 160, origin: { y: 0.6 } });
    }

    // --- 4. リセット処理 ---
    document.getElementById('retry-button').onclick = () => {
      isCapturing = false;
      switchScreen('start');
    };

    // 初期化
    initialize();
  </script>
</body>
</html>
